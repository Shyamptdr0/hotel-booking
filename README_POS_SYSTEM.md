# Restaurant POS Table Management System with Real-time Synchronization

## Overview

This system implements a restaurant POS table management system that supports real-time bill synchronization across multiple devices (3 or more terminals). All table statuses and bill items are shared and synced across all devices using a centralized database as the single source of truth.

## Architecture

### Data Flow

1. **Temporary Items Storage**: While a bill is in running state, items are saved only in the `temporary_items` database table
2. **Final Bill Creation**: A final bill record is created only when the Print Bill button is clicked
3. **Real-time Sync**: All devices poll the database every 2 seconds for updates
4. **Device Locking**: Only one device can edit at a time to prevent conflicts

### Table Status Flow

```
Blank (White) → Running (Blue) → Paid/Printed (Amber) → Blank (White)
     ↑                                                        ↓
     ←─────────── Settlement ←─────────────────────────────────
```

## Database Schema

### temporary_items Table

```sql
CREATE TABLE temporary_items (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  table_id BIGINT NOT NULL,
  table_name VARCHAR(255),
  section VARCHAR(100),
  item_id BIGINT NOT NULL,
  item_name VARCHAR(255) NOT NULL,
  item_category VARCHAR(100),
  quantity INTEGER NOT NULL DEFAULT 1,
  price DECIMAL(10,2) NOT NULL,
  total DECIMAL(10,2) NOT NULL,
  device_id VARCHAR(255), -- Device identifier for locking
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### bills Table (Existing)
- Stores final bills after printing
- Status: `running`, `printed`, `paid`, `settled`

### tables Table (Existing)
- Status: `blank`, `running`, `printed`, `paid`, `running_kot`

## API Endpoints

### Temporary Items API
- `GET /api/temporary-items?table_id={id}` - Get items for a table
- `POST /api/temporary-items` - Save items to temporary storage
- `PUT /api/temporary-items` - Update items and device lock
- `DELETE /api/temporary-items?table_id={id}` - Clear items for a table

### Tables API (Existing)
- `GET /api/tables` - Get all tables
- `PUT /api/tables/{id}` - Update table status
- `DELETE /api/tables/{id}` - Delete table

### Bills API (Existing)
- `GET /api/bills` - Get bills with filters
- `POST /api/bills` - Create final bill
- `PUT /api/bills/{id}` - Update bill status

## Components

### Create Bill Page (`/billing/create`)
- Loads items from temporary storage instead of localStorage
- Implements device locking mechanism
- Real-time synchronization with polling
- Shows lock warning when another device is editing

### Print from Temporary Page (`/billing/print-temporary/[tableId]`)
- Creates final bills from temporary items
- Updates table status to 'paid'
- Clears temporary items after printing
- Handles print customization

### Tables Page (`/tables`)
- Updated to use temporary items API
- Direct navigation to print-from-temporary for running tables
- Updated settlement flow to clear database items

## Real-time Synchronization

### Device Locking
- Each device generates a unique ID stored in localStorage
- First device to open a table gets editing rights
- Other devices see read-only view with lock warning
- Device lock expires after 2 seconds of inactivity

### Polling Mechanism
- Polls `/api/temporary-items` every 2 seconds
- Updates device lock timestamp
- Detects conflicts and shows warnings
- Syncs item changes across devices

## Color Coding

| Status | Color | Description |
|--------|--------|-------------|
| blank | White | No active bill |
| running | Blue | Items saved, bill not printed |
| printed | Green | Bill printed |
| paid | Amber/Yellow | Payment settled |
| running_kot | Orange | KOT running |

## Installation & Setup

### 1. Database Migration
Run the SQL migration to create the temporary_items table:

```sql
-- Run the file: database/migrations/create_temporary_items.sql
```

### 2. Environment Variables
Ensure your `.env.local` has:
```
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

### 3. Start the Application
```bash
npm run dev
```

## Multi-Device Testing

### Testing Scenario
1. Open the application on 3 different devices/browsers
2. Device 1: Open Table 1 and add items
3. Device 2: Open Table 1 - should show lock warning
4. Device 3: Open Table 2 and add different items
5. Device 1: Print bill - should clear items and update status
6. Device 2: Should see table status change
7. Device 3: Continue working independently

### Expected Behavior
- All devices show same table statuses
- Only one device can edit a table at a time
- Changes sync in real-time (within 2 seconds)
- Print operation creates final bill and clears temporary items
- Settlement resets table to blank across all devices

## File Structure

```
src/
├── app/
│   ├── api/
│   │   └── temporary-items/
│   │       └── route.js          # Temporary items API
│   ├── billing/
│   │   ├── create/
│   │   │   └── page.js           # Updated create bill page
│   │   └── print-temporary/
│   │       └── [tableId]/
│   │           └── page.js       # Print from temporary items
│   └── tables/
│       └── page.js               # Updated tables page
├── hooks/
│   └── useWebSocket.js           # Real-time sync hook
└── database/
    └── migrations/
        └── create_temporary_items.sql
```

## Security Considerations

- Device IDs are stored in localStorage (client-side)
- Row Level Security enabled on temporary_items table
- API endpoints use Supabase authentication
- In production, implement proper user-based access control

## Performance Optimizations

- Database indexes on table_id and device_id
- Polling interval of 2 seconds (configurable)
- Efficient CRUD operations on temporary items
- Minimal data transfer in API responses

## Future Enhancements

1. **WebSocket Implementation**: Replace polling with WebSockets for true real-time updates
2. **User Authentication**: Implement proper user-based device locking
3. **Offline Support**: Add service worker for offline functionality
4. **Conflict Resolution**: Advanced conflict detection and resolution
5. **Audit Trail**: Track all changes with user and device information

## Troubleshooting

### Common Issues

1. **Device Lock Not Working**: Check that device_id is generated correctly
2. **Items Not Syncing**: Verify database connection and API endpoints
3. **Table Status Not Updating**: Check table status flow and API calls
4. **Print Not Working**: Ensure temporary items exist before printing

### Debug Mode
Enable console logging to debug synchronization issues:
```javascript
// In useWebSocket.js, enable detailed logging
console.log('Sync update:', message)
```

## Support

For issues and questions:
1. Check the browser console for errors
2. Verify database connection in Supabase dashboard
3. Test API endpoints directly
4. Check network requests in browser dev tools
